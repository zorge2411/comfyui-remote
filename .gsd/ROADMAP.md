# ROADMAP.md

> **Current Milestone**: Milestone 3: Image Input Support
> **Goal**: Enable users to use images from their device (gallery or camera) as inputs for ComfyUI workflows.

## Must-Haves

- [ ] TBD

## Nice-to-Haves

- [ ] Real Progress Indicator (Step progress/Unified progress bar)

## Phases

### Backlog

### Phase 16: Icon Refinement

**Status**: ✅ Done
**Objective**: Generate 5 premium icon concepts, allow user selection, and implement the chosen icon.

**Tasks**:

- [x] Create Plan
- [x] Generate 5 Icon Concepts
- [x] User Selection
- [x] Implement Icon Generator Script
- [x] Generate Mipmap Assets
- [x] Verify Build

### Phase 29: Model Listing in Workflow List

**Status**: ✅ Done
**Objective**: Display the safeTensor/checkpoint name on the workflow list item for quick identification.

**Tasks**:

- [x] Create Plan
- [x] Implement Schema Changes (v5)
- [x] Implement Parsing Logic
- [x] Implement UI (Badges)
- [x] Verify

### Phase 30: Support for Importing Graph Format JSON

**Status**: ✅ Done
**Objective**: Enable functionality to import workflows defined in the graph JSON format.
**Depends on**: Phase 29

**Tasks**:

- [x] Create GraphToApiConverter
- [x] Integrate Converter in MainViewModel
- [x] Update Import Dialog
- [x] Verify (Unit Tests Implemented)

**Verification**:

- Import `workflow.json` (Graph Format)
- Confirm it appears in list
- Run it and verify execution starts

### Phase 31: Sync Gallery & History

**Status**: ✅ Done
**Objective**: Synchronize the local app gallery with the ComfyUI server history on startup to ensure consistency across devices/sessions.
**Depends on**: Mileage 2 Completion

**Tasks**:

- [x] Create Phase Plan
- [x] Implement Sync Logic in MainViewModel
- [x] Optimize DAO with getAllPromptIds
- [x] Verify Sync on Startup

---

### Phase 32: Pull to Sync Gallery & History

**Status**: ✅ Done
**Objective**: Implement pull-to-refresh functionality on the Gallery and History pages to manually trigger synchronization with the ComfyUI server.
**Depends on**: Phase 31

**Tasks**:

- [x] Implement `isSyncing` state in `MainViewModel`
- [x] Update `syncHistory` with state management
- [x] Add `PullToRefreshBox` to `GalleryScreen`
- [x] Add `PullToRefreshBox` to `HistoryScreen`
- [x] Verify functionality

**Verification**:

- [ ] Pull down on Gallery screen triggers sync
- [ ] Pull down on History screen triggers sync
- [ ] UI reflects loading state during sync

---

### Phase 33: Theme Mode Selection

**Status**: ✅ Done
**Tasks**:

- [x] Implement `THEME_MODE_KEY` in `UserPreferencesRepository`
- [x] Add `themeMode` state and setter to `MainViewModel`
- [x] Refactor `Theme.kt` to accept explicit `themeMode`
- [x] Update `MainActivity.kt` to pass `themeMode` to theme wrapper
- [x] Add Theme selection UI in `SettingsScreen.kt`
- [x] Verify functionality

### Phase 34: Media Detail Individual Delete

**Status**: ✅ Done
**Tasks**:

- [x] Add Delete icon to `MediaDetailScreen` top bar
- [x] Implement confirmation dialog
- [x] Hook up `viewModel.deleteMedia`
- [x] Navigate back after delete

### Phase 35: Storage & UX Polish

**Status**: ✅ Done
**Objective**: Refine "Save to Device" flow, persistent folder permissions, and implement multi-select delete and transitions.

**Tasks**:

- [x] Implement Long-press Multi-select in Gallery
- [x] Add Shared Element Transitions (Grid <-> Detail)
- [x] Add "Reset Folder" option in Settings
- [x] Add "Save Successful" Snackbar
- [x] Verify functionality

### Phase 36: Image Upload Infrastructure

**Status**: ✅ Done
**Objective**: Implement the backend networking and repository layer to upload images to the ComfyUI server.

**Tasks**:

- [x] Create Phase Plan
- [x] Implement `uploadImage` in `ComfyApi`
- [x] Create `ImageRepository` with `uploadImage` function
- [x] Verify with Unit Test (Build Verified)

### Phase 37: Image Input Component

**Status**: ✅ Done
**Objective**: Create a UI component to pick an image from the Android system picker and display a preview.

### Phase 38: Workflow Integration

**Status**: ✅ Done
**Objective**: Map LoadImage nodes to the ImageSelector and ensure API request uses uploaded filename.

### Phase 40: Multi-Image Sync

**Status**: ✅ Done
**Objective**: Ensure all images generated by a workflow are synchronized to the gallery, not just the first one.

### Phase 39: Camera Integration

**Status**: ✅ Done
**Objective**: Add an option to take a photo directly within the app.

### Phase 41: History Selection Fix

**Status**: ✅ Done
**Objective**: Fix the bug where selecting a history item incorrectly displays the previous global generation result instead of the specific history image.

### Phase 42: Manual Image Upload to Gallery

**Status**: ✅ Done
**Objective**: Add a button to the Gallery to manually upload images from the device to the ComfyUI server and display them in the app.

### Phase 43: Progress Indicator & Node Tracking

**Status**: ✅ Done
**Objective**: Provide real-time feedback during workflow execution, showing current node progress and overall job status.

### Phase 44: Camera Option in Gallery

**Status**: ✅ Done
**Objective**: Allow users to take a photo directly from the Gallery screen to upload as an input image.

### Phase 45: Camera Fix (Reliable Upload)

**Status**: ✅ Done
**Objective**: Refactor Activity launchers to ensure camera photos are reliably added to the gallery after capture.

### Phase 46: Gallery Visibility & State Fix

**Status**: ✅ Done
**Objective**: Fix state loss when opening camera and improve upload metadata to ensure images appear correctly in the gallery.

### Phase 47: Fix Compilation Error

**Status**: ✅ Done
**Objective**: Resolve type mismatch in `DynamicFormScreen.kt` following the `uploadImage` API change.

### Phase 48: Debug Network & Manifest

**Status**: ✅ Done
**Objective**: Resolve `UnknownHostException` by standardizing default server address and fix Android 13+ back navigation warnings.

### Phase 49: Fetch Workflows from Server Userdata

**Status**: ✅ Done
**Objective**: Allow the app to fetch and display workflows stored on the ComfyUI server under the `userdata/workflows` directory.

**Tasks**:

- [x] Add `getUserData` to `ComfyApiService`
- [x] Implement `fetchServerWorkflows` in `MainViewModel`
- [x] Parse `userdata` response into `ServerWorkflow` models
- [x] Update UI to display and trigger server-side workflow fetch
- [x] Verify functionality with real or mocked server

---

### Phase 50: Normalization Service

**Status**: ✅ Done
**Objective**: Standardize, validate, and optimize ComfyUI workflows during import to ensure consistency and robustness across different sources.
**Depends on**: Phase 49

- [x] Create `WorkflowNormalizationService` with model extraction <!-- id: 50.1 -->
- [x] Implement UI metadata stripping in `WorkflowParser` <!-- id: 50.2 -->
- [x] Add `baseModels` and `source` fields to `WorkflowEntity` <!-- id: 50.3 -->
- [x] Integrate normalization into `MainViewModel.importWorkflow` <!-- id: 50.4 -->
- [x] Verify with unit tests for API and Workspace formats <!-- id: 50.5 -->

**Verification**:

- [ ] Unit tests pass for both JSON formats
- [ ] Imported workflows show "Detected Models" in the UI
- [ ] `WorkflowEntity` in DB contains normalized JSON without unnecessary UI keys

### Phase 51: Fix Scrolling Lag in Gallery

**Status**: ✅ Done
**Objective**: Fix the scrolling lag in the gallery screen.
**Depends on**: Phase 50

**Tasks**:

- [x] Create Plan
- [x] Implement Batch Insert in DAO & Repository
- [x] Refactor MainViewModel.syncHistory
- [x] Configure Coil ImageLoader
- [x] Verify functionality

**Verification**:

- [ ] Syncing multiple history items does not cause UI lag
- [ ] Gallery scrolling is smooth (60fps)
- [ ] Images load with crossfade transition

### Phase 52: Resource Selection Dropdowns

**Status**: ✅ Done
**Objective**: Enhance the workflow execution form by replacing text inputs with dropdown/selection lists for server-side resources (Checkpoints, LoRAs, VAEs, etc.), improving usability and reducing errors.
**Depends on**: Phase 51

**Tasks**:

- [x] Create Phase Plan (52-PLAN.md)
- [x] Implement SelectionInput and WorkflowParser changes
- [x] Update DynamicFormScreen UI
- [x] Verify functionality

**Verification**:

- TBD

---

### Phase 53: Synced Server Workflow Population

**Status**: ⬜ Not Started
**Objective**: Populate nodes from synced server workflows (userdata/history) to enable dynamic form generation, matching "Template" workflow behavior.
**Depends on**: Phase 52

**Tasks**:

- [ ] TBD (run /plan 53 to create)

**Verification**:

- TBD

---

### Phase 54: Icon Refinement II

**Status**: ⬜ Not Started
**Objective**: Audit current app icon implementation, identify inconsistencies between vector XML and PNG assets, and propose upgrades for improved visual quality and modern adaptive icon support.
**Depends on**: None (standalone)

**Tasks**:

- [ ] TBD (run /plan 54 to create)

**Verification**:

- TBD
