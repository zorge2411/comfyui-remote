# ROADMAP.md

> **Current Milestone**: Milestone 3: Image Input Support
> **Goal**: Enable users to use images from their device (gallery or camera) as inputs for ComfyUI workflows.

## Must-Haves

- [ ] TBD

## Nice-to-Haves

- [ ] Real Progress Indicator (Step progress/Unified progress bar)

## Phases

### Backlog

### Phase 16: Icon Refinement

**Status**: ✅ Done
**Objective**: Generate 5 premium icon concepts, allow user selection, and implement the chosen icon.

**Tasks**:

- [x] Create Plan
- [x] Generate 5 Icon Concepts
- [x] User Selection
- [x] Implement Icon Generator Script
- [x] Generate Mipmap Assets
- [x] Verify Build

### Phase 29: Model Listing in Workflow List

**Status**: ✅ Done
**Objective**: Display the safeTensor/checkpoint name on the workflow list item for quick identification.

**Tasks**:

- [x] Create Plan
- [x] Implement Schema Changes (v5)
- [x] Implement Parsing Logic
- [x] Implement UI (Badges)
- [x] Verify

### Phase 30: Support for Importing Graph Format JSON

**Status**: ✅ Done
**Objective**: Enable functionality to import workflows defined in the graph JSON format.
**Depends on**: Phase 29

**Tasks**:

- [x] Create GraphToApiConverter
- [x] Integrate Converter in MainViewModel
- [x] Update Import Dialog
- [x] Verify (Unit Tests Implemented)

**Verification**:

- Import `workflow.json` (Graph Format)
- Confirm it appears in list
- Run it and verify execution starts

### Phase 31: Sync Gallery & History

**Status**: ✅ Done
**Objective**: Synchronize the local app gallery with the ComfyUI server history on startup to ensure consistency across devices/sessions.
**Depends on**: Mileage 2 Completion

**Tasks**:

- [x] Create Phase Plan
- [x] Implement Sync Logic in MainViewModel
- [x] Optimize DAO with getAllPromptIds
- [x] Verify Sync on Startup

---

### Phase 32: Pull to Sync Gallery & History

**Status**: ✅ Done
**Objective**: Implement pull-to-refresh functionality on the Gallery and History pages to manually trigger synchronization with the ComfyUI server.
**Depends on**: Phase 31

**Tasks**:

- [x] Implement `isSyncing` state in `MainViewModel`
- [x] Update `syncHistory` with state management
- [x] Add `PullToRefreshBox` to `GalleryScreen`
- [x] Add `PullToRefreshBox` to `HistoryScreen`
- [x] Verify functionality

**Verification**:

- [ ] Pull down on Gallery screen triggers sync
- [ ] Pull down on History screen triggers sync
- [ ] UI reflects loading state during sync

---

### Phase 33: Theme Mode Selection

**Status**: ✅ Done
**Tasks**:

- [x] Implement `THEME_MODE_KEY` in `UserPreferencesRepository`
- [x] Add `themeMode` state and setter to `MainViewModel`
- [x] Refactor `Theme.kt` to accept explicit `themeMode`
- [x] Update `MainActivity.kt` to pass `themeMode` to theme wrapper
- [x] Add Theme selection UI in `SettingsScreen.kt`
- [x] Verify functionality

### Phase 34: Media Detail Individual Delete

**Status**: ✅ Done
**Tasks**:

- [x] Add Delete icon to `MediaDetailScreen` top bar
- [x] Implement confirmation dialog
- [x] Hook up `viewModel.deleteMedia`
- [x] Navigate back after delete

### Phase 35: Storage & UX Polish

**Status**: ✅ Done
**Objective**: Refine "Save to Device" flow, persistent folder permissions, and implement multi-select delete and transitions.

**Tasks**:

- [x] Implement Long-press Multi-select in Gallery
- [x] Add Shared Element Transitions (Grid <-> Detail)
- [x] Add "Reset Folder" option in Settings
- [x] Add "Save Successful" Snackbar
- [x] Verify functionality

### Phase 36: Image Upload Infrastructure

**Status**: ✅ Done
**Objective**: Implement the backend networking and repository layer to upload images to the ComfyUI server.

**Tasks**:

- [x] Create Phase Plan
- [x] Implement `uploadImage` in `ComfyApi`
- [x] Create `ImageRepository` with `uploadImage` function
- [x] Verify with Unit Test (Build Verified)

### Phase 37: Image Input Component

**Status**: ✅ Done
**Objective**: Create a UI component to pick an image from the Android system picker and display a preview.

### Phase 38: Workflow Integration

**Status**: ✅ Done
**Objective**: Map LoadImage nodes to the ImageSelector and ensure API request uses uploaded filename.

### Phase 40: Multi-Image Sync

**Status**: ✅ Done
**Objective**: Ensure all images generated by a workflow are synchronized to the gallery, not just the first one.

### Phase 39: Camera Integration

**Status**: ✅ Done
**Objective**: Add an option to take a photo directly within the app.

### Phase 41: History Selection Fix

**Status**: ✅ Done
**Objective**: Fix the bug where selecting a history item incorrectly displays the previous global generation result instead of the specific history image.

### Phase 42: Manual Image Upload to Gallery

**Status**: ✅ Done
**Objective**: Add a button to the Gallery to manually upload images from the device to the ComfyUI server and display them in the app.

### Phase 43: Progress Indicator & Node Tracking

**Status**: ✅ Done
**Objective**: Provide real-time feedback during workflow execution, showing current node progress and overall job status.

### Phase 44: Camera Option in Gallery

**Status**: ✅ Done
**Objective**: Allow users to take a photo directly from the Gallery screen to upload as an input image.

### Phase 45: Camera Fix (Reliable Upload)

**Status**: ✅ Done
**Objective**: Refactor Activity launchers to ensure camera photos are reliably added to the gallery after capture.

### Phase 46: Gallery Visibility & State Fix

**Status**: ✅ Done
**Objective**: Fix state loss when opening camera and improve upload metadata to ensure images appear correctly in the gallery.

### Phase 47: Fix Compilation Error

**Status**: ✅ Done
**Objective**: Resolve type mismatch in `DynamicFormScreen.kt` following the `uploadImage` API change.

### Phase 48: Debug Network & Manifest

**Status**: ✅ Done
**Objective**: Resolve `UnknownHostException` by standardizing default server address and fix Android 13+ back navigation warnings.

### Phase 49: Fetch Workflows from Server Userdata

**Status**: ✅ Done
**Objective**: Allow the app to fetch and display workflows stored on the ComfyUI server under the `userdata/workflows` directory.

**Tasks**:

- [x] Add `getUserData` to `ComfyApiService`
- [x] Implement `fetchServerWorkflows` in `MainViewModel`
- [x] Parse `userdata` response into `ServerWorkflow` models
- [x] Update UI to display and trigger server-side workflow fetch
- [x] Verify functionality with real or mocked server

---

### Phase 50: Normalization Service

**Status**: ✅ Done
**Objective**: Standardize, validate, and optimize ComfyUI workflows during import to ensure consistency and robustness across different sources.
**Depends on**: Phase 49

- [x] Create `WorkflowNormalizationService` with model extraction <!-- id: 50.1 -->
- [x] Implement UI metadata stripping in `WorkflowParser` <!-- id: 50.2 -->
- [x] Add `baseModels` and `source` fields to `WorkflowEntity` <!-- id: 50.3 -->
- [x] Integrate normalization into `MainViewModel.importWorkflow` <!-- id: 50.4 -->
- [x] Verify with unit tests for API and Workspace formats <!-- id: 50.5 -->

**Verification**:

- [ ] Unit tests pass for both JSON formats
- [ ] Imported workflows show "Detected Models" in the UI
- [ ] `WorkflowEntity` in DB contains normalized JSON without unnecessary UI keys

### Phase 51: Fix Scrolling Lag in Gallery

**Status**: ✅ Done
**Objective**: Fix the scrolling lag in the gallery screen.
**Depends on**: Phase 50

**Tasks**:

- [x] Create Plan
- [x] Implement Batch Insert in DAO & Repository
- [x] Refactor MainViewModel.syncHistory
- [x] Configure Coil ImageLoader
- [x] Verify functionality

**Verification**:

- [ ] Syncing multiple history items does not cause UI lag
- [ ] Gallery scrolling is smooth (60fps)
- [ ] Images load with crossfade transition

### Phase 52: Resource Selection Dropdowns

**Status**: ✅ Done
**Objective**: Enhance the workflow execution form by replacing text inputs with dropdown/selection lists for server-side resources (Checkpoints, LoRAs, VAEs, etc.), improving usability and reducing errors.
**Depends on**: Phase 51

**Tasks**:

- [x] Create Phase Plan (52-PLAN.md)
- [x] Implement SelectionInput and WorkflowParser changes
- [x] Update DynamicFormScreen UI
- [x] Verify functionality

**Verification**:

- TBD

---

### Phase 53: Synced Server Workflow Population

**Status**: ✅ Complete
**Objective**: Populate nodes from synced server workflows (userdata/history) to enable dynamic form generation, matching "Template" workflow behavior.
**Depends on**: Phase 52

**Tasks**:

- [ ] TBD (run /plan 53 to create)

**Verification**:

- TBD

---

### Phase 54: Icon Refinement II

**Status**: ✅ Done
**Objective**: Audit current app icon implementation, identify inconsistencies between vector XML and PNG assets, and propose upgrades for improved visual quality and modern adaptive icon support.
**Depends on**: None (standalone)

**Tasks**:

- [x] Create Plan
- [x] Create mipmap-anydpi-v26 structure
- [x] Create compat drawable for legacy PNG
- [x] Configure Adaptive Icon XMLs
- [x] Standardize Background Color
- [x] Verify Build

**Verification**:

- [x] Build Successful
- [ ] Visual Verification (Manual)

### Phase 55: Connect on Enter Key

**Status**: ✅ Done
**Objective**: Improve the connection screen UX by ensuring the 'Enter' key triggers the connection action (or moves focus) instead of creating a new line in the IP address field.

**Tasks**:

- [x] Create Plan
- [x] Update ConnectionScreen Input Fields
- [x] Verify Behavior

**Verification**:

- [x] pressing Enter on IP field triggers Connect
- [x] pressing Enter on Port field triggers Connect
- [x] No newlines in IP field

### Phase 56: Keyboard Management UX

**Status**: ✅ Done
**Objective**: Ensure the software keyboard is dismissed when the 'Connect' action is triggered from the keyboard or the button, preventing UI overlap and improving visibility during the connection state.

**Tasks**:

- [x] Create Plan
- [x] Implement Keyboard Dismissal Logic
- [x] Verify Behavior

**Verification**:

- [x] Pressing Enter on IP/Port field dismisses the keyboard.
- [x] Clicking the 'Connect' button dismisses the keyboard.

### Phase 57: Empty IP/Port Crash Fix

**Status**: ✅ Done
**Objective**: Prevent app crash when the user attempts to connect with empty or invalid IP address and port fields.

**Tasks**:

- [x] Create Plan
- [x] Add Input Validation to ConnectionScreen
- [x] Verify Behavior

**Verification**:

- [x] Empty IP + Connect → shows error, no crash
- [x] Empty Port + Connect → shows error, no crash
- [x] Valid IP + Port + Connect → connects normally

---

## Phase 58: Gallery Sync & Reliability Optimization

**Status**: ✅ Done
**Objective**: Resolve slow gallery loading and image timeouts via early stream termination and unified network configuration.

**Tasks**:

- [x] Centralize OkHttpClient with 30s timeouts
- [x] Implement early `break` in history sync stream
- [x] Extract `type` (output/input/temp) for correct image URLs
- [x] Limit syncHistory to last 100 items (v1)

**Verification**:

- [x] Successful build
- [x] Verified stream closure significantly reduces sync time for existing data.

---

### Phase 59: Server IP Address Selection

**Status**: ✅ Done
**Objective**: Add a combo box to the connection screen allowing users to select from up to 5 saved server IP addresses, improving UX for users who connect to multiple ComfyUI servers.
**Depends on**: Phase 58

**Tasks**:

- [x] Create ServerProfile data class and update UserPreferencesRepository
- [x] Update MainViewModel with server profile state
- [x] Update ConnectionScreen UI with dropdown

**Verification**:

- [x] Build succeeds
- [x] Dropdown shows saved servers, selection auto-fills fields
- [x] Max 5 servers maintained (FIFO)

### Phase 60: Link Result to Gallery

**Status**: ✅ Done
**Objective**: Enable direct navigation from a generated image result to its full view in the Gallery, allowing for immediate management (zoom, share, delete).
**Depends on**: Phase 40

**Tasks**:

- [x] Create Plan
- [x] Implement Navigation Logic
- [x] Add UI Action on Result Image
- [x] Verify Navigation

### Phase 61: Add Back Button on Workflow Generation

**Status**: ✅ Done
**Objective**: Improve navigation by adding an explicit back button to the workflow generation screen, allowing users to easily return to the workflow list.
**Depends on**: None

**Tasks**:

- [ ] Create Plan
- [ ] Add Back Callback to DynamicFormScreen
- [ ] Add Back Icon to Header
- [ ] Update MainActivity Navigation

### Phase 62: Copy Button for Prompt Inputs

**Status**: ✅ Done
**Objective**: Add a "Copy" button to text input fields (especially prompts) to allow users to quickly copy the entire prompt text to the clipboard.
**Depends on**: None

**Tasks**:

- [x] Create Plan
- [x] Implement Clipboard Utility in ViewModel
- [x] Update UI with Copy Icon in TextField
- [x] Add Snackbar confirmation
- [x] Verify functionality

### Phase 63: Fix Reverted App Icon

**Status**: ✅ Complete
**Objective**: Restore the correct application icon that was accidentally reverted during a recent pull request/merge.
**Depends on**: None

**Tasks**:

- [x] Investigate current icon configuration
- [x] Restore correct icon assets/manifest reference
- [x] Verify correct icon is displayed

### Phase 64: Image-to-Image Support

**Status**: ✅ Complete
**Objective**: Enable using device images as input for workflows (Img2Img), supporting image upload and execution patching.
**Depends on**: Phase 62

**Tasks**:

- [x] Create `WorkflowPatchingService`
- [x] Update `MainViewModel` for Input State & Upload Logic
- [x] Patch `GraphToApiConverter` for `LoadImage` fallback
- [x] Integrate `ImageSelector` in `DynamicFormScreen`
- [x] Verify Implementation

### Phase 65: Robust Workflow Handling

**Status**: ✅ Done
**Objective**: Prevent execution failures by ensuring unknown/custom nodes (missing metadata) are not skipped during conversion, employing heuristic input mapping where possible.
**Depends on**: Phase 64

**Tasks**:

- [x] Modify `GraphToApiConverter` to stop skipping unknown nodes
- [x] Implement heuristic input mapping for Primitives/Loaders
- [x] Verify fix with problem workflow

### Phase 66: Heuristic Link Flattening

**Status**: ✅ Done
**Objective**: Detect and recursively bypass "unknown" nodes (missing metadata) by linking their consumers directly to their upstream inputs. This handles frontend-only nodes like custom Reroutes or Groups that the server rejects.
**Depends on**: Phase 65

**Tasks**:

- [x] Create `GraphToApiConverterFlatteningTest` to enable TDD
- [x] Implement `flattenLinks` logic in `GraphToApiConverter`
  - [x] Handle Single-Hop bypass
  - [x] Handle Multi-Hop bypass (Recursion)
  - [x] Handle Multi-Input ambiguity (First input priority)
- [x] Integrate flattening into the conversion pipeline
- [x] Verify with previously failing workflow logs
